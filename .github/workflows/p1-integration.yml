name: P1 Features CI/CD

on:
  push:
    branches:
      - 'claude/slide-designer-p1-*'
      - main
      - develop
    paths:
      - 'src/p1/**'
      - 'src/p0/**'
      - 'tests/p1/**'
      - 'package.json'
      - 'tsconfig.json'
      - '.github/workflows/p1-integration.yml'
  pull_request:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '20.x'
  CACHE_NAME: p1-integration
  FEATURE_FLAGS_FILE: 'config/feature-flags.json'

jobs:
  typecheck:
    name: TypeScript Type Checking (P1)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        env:
          NODE_ENV: development

      - name: Run TypeScript type checking
        run: npm run typecheck

      - name: Upload typecheck results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: p1-typecheck-errors
          path: |
            tsconfig.json
            src/p1/**/*.ts
          retention-days: 7

  lint:
    name: ESLint Code Quality (P1)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint on P1 features
        run: npm run lint -- "src/p1/**/*.ts" "tests/p1/**/*.ts"
        continue-on-error: true

      - name: Generate lint report
        if: always()
        run: |
          npm run lint -- "src/p1/**/*.ts" --format json --output-file p1-lint-report.json || true
          echo "# P1 Lint Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Lint check completed for P1 features. Check artifacts for details." >> $GITHUB_STEP_SUMMARY

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p1-lint-report
          path: p1-lint-report.json
          retention-days: 30

  p1-unit-tests:
    name: P1 Unit Tests
    runs-on: ubuntu-latest
    needs: [typecheck, lint]

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
        batch: [batch1, batch2, batch3, batch4, batch5]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run P1 ${{ matrix.batch }} unit tests
        run: npm run test -- --testPathPattern="p1/${{ matrix.batch }}" --coverage --maxWorkers=2
        env:
          NODE_ENV: test
          P1_FEATURES_ENABLED: true

      - name: Upload test coverage for ${{ matrix.batch }}
        if: matrix.node-version == '20.x'
        uses: actions/upload-artifact@v4
        with:
          name: p1-coverage-${{ matrix.batch }}
          path: coverage/
          retention-days: 30

      - name: Check coverage thresholds
        if: matrix.node-version == '20.x'
        run: |
          echo "# P1 ${{ matrix.batch }} Test Coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Coverage report generated for ${{ matrix.batch }} on Node ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY

  p0-p1-integration-tests:
    name: P0+P1 Integration Tests
    runs-on: ubuntu-latest
    needs: p1-unit-tests

    strategy:
      matrix:
        integration-suite:
          - p0-baseline
          - p1-batch1-integration
          - p1-batch2-integration
          - p1-batch3-integration
          - p1-batch4-integration
          - p1-batch5-integration
          - full-integration
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run ${{ matrix.integration-suite }} tests
        run: npm run test:integration -- --testNamePattern="${{ matrix.integration-suite }}"
        timeout-minutes: 15
        env:
          P1_FEATURES_ENABLED: true

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p1-integration-results-${{ matrix.integration-suite }}
          path: test-results/
          retention-days: 30

  feature-flag-tests:
    name: Feature Flag Testing
    runs-on: ubuntu-latest
    needs: p1-unit-tests

    strategy:
      matrix:
        scenario:
          - all-enabled
          - all-disabled
          - batch1-only
          - batch2-only
          - batch3-only
          - batch4-only
          - batch5-only
          - incremental-batch1-2
          - incremental-batch1-2-3
          - random-mix
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Configure feature flags - ${{ matrix.scenario }}
        run: |
          node scripts/configure-feature-flags.js --scenario ${{ matrix.scenario }}
          echo "# Feature Flag Configuration: ${{ matrix.scenario }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat ${{ env.FEATURE_FLAGS_FILE }} >> $GITHUB_STEP_SUMMARY

      - name: Run tests with feature flag configuration
        run: npm run test:feature-flags -- --scenario=${{ matrix.scenario }}
        timeout-minutes: 10
        env:
          FEATURE_FLAG_SCENARIO: ${{ matrix.scenario }}

      - name: Upload feature flag test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: feature-flag-results-${{ matrix.scenario }}
          path: |
            test-results/
            ${{ env.FEATURE_FLAGS_FILE }}
          retention-days: 30

  batch-compatibility-tests:
    name: Batch Compatibility Matrix
    runs-on: ubuntu-latest
    needs: p1-unit-tests

    strategy:
      matrix:
        batch-combo:
          - batch1
          - batch1-batch2
          - batch1-batch2-batch3
          - batch1-batch2-batch3-batch4
          - batch1-batch2-batch3-batch4-batch5
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run compatibility tests - ${{ matrix.batch-combo }}
        run: npm run test:batch-compatibility -- --batches=${{ matrix.batch-combo }}
        timeout-minutes: 12

      - name: Generate compatibility report
        if: always()
        run: |
          echo "# Batch Compatibility: ${{ matrix.batch-combo }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tested batches: ${{ matrix.batch-combo }}" >> $GITHUB_STEP_SUMMARY

      - name: Upload compatibility results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: batch-compatibility-${{ matrix.batch-combo }}
          path: test-results/
          retention-days: 30

  build:
    name: Build Verification (P1)
    runs-on: ubuntu-latest
    needs: [typecheck, lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript with P1 features
        run: npm run build
        env:
          P1_BUILD: true

      - name: Verify P1 build output
        run: |
          if [ ! -d "dist/p1" ]; then
            echo "Build warning: dist/p1 directory not created"
          fi

          if [ ! -f "dist/index.js" ]; then
            echo "Build failed: dist/index.js not found"
            exit 1
          fi

          echo "Build verification successful"
          echo "# P1 Build Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build completed successfully with P1 features" >> $GITHUB_STEP_SUMMARY
          echo "- Output directory: dist/" >> $GITHUB_STEP_SUMMARY
          echo "- Main entry point: dist/index.js" >> $GITHUB_STEP_SUMMARY

      - name: Check build size
        run: |
          BUILD_SIZE=$(du -sh dist | cut -f1)
          P1_SIZE=$(du -sh dist/p1 2>/dev/null | cut -f1 || echo "N/A")
          echo "Total build size: $BUILD_SIZE"
          echo "P1 features size: $P1_SIZE"
          echo "- Total build size: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- P1 features size: $P1_SIZE" >> $GITHUB_STEP_SUMMARY

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: p1-build-output
          path: dist/
          retention-days: 7

  performance-benchmark-p1:
    name: P1 Performance Benchmarks
    runs-on: ubuntu-latest
    needs: build

    strategy:
      matrix:
        batch: [batch1, batch2, batch3, batch4, batch5]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run P1 ${{ matrix.batch }} benchmarks
        run: npm run bench:p1:${{ matrix.batch }}
        timeout-minutes: 15

      - name: Generate benchmark report
        if: always()
        run: |
          npm run bench:report -- --batch=${{ matrix.batch }} || echo "Benchmark report generation skipped"

      - name: Upload benchmark results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p1-benchmark-${{ matrix.batch }}
          path: |
            benchmarks/p1/${{ matrix.batch }}/*.json
            benchmarks/p1/${{ matrix.batch }}/*.md
          retention-days: 30

  regression-tests:
    name: P0 Regression Tests
    runs-on: ubuntu-latest
    needs: [p0-p1-integration-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project with P1 features
        run: npm run build
        env:
          P1_FEATURES_ENABLED: true

      - name: Run P0 regression tests
        run: npm run test:p0:regression
        timeout-minutes: 10
        env:
          P1_FEATURES_ENABLED: true

      - name: Compare with baseline
        run: |
          echo "# P0 Regression Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verifying P0 features still work with P1 enabled" >> $GITHUB_STEP_SUMMARY

      - name: Upload regression results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p0-regression-results
          path: test-results/regression/
          retention-days: 30

  security-audit:
    name: Security Audit (P1)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Run npm audit
        run: |
          npm audit --audit-level=moderate || true
          npm audit --json > p1-audit-report.json || true

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: p1-security-audit
          path: p1-audit-report.json
          retention-days: 30

  deploy-batch1:
    name: Deploy P1 Batch 1
    runs-on: ubuntu-latest
    needs: [p1-unit-tests, p0-p1-integration-tests, build, feature-flag-tests]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/claude/slide-designer-p1')

    environment:
      name: production-p1-batch1
      url: https://flow-nexus.ruv.io/p1/batch1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: p1-build-output
          path: dist/

      - name: Install dependencies
        run: npm ci --production

      - name: Deploy Batch 1
        run: bash ./scripts/deploy-p1.sh --batch=1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_ENV: production
          P1_BATCH: 1

      - name: Health check Batch 1
        run: |
          echo "Running post-deployment health checks for Batch 1..."
          sleep 5
          npm run health-check:p1:batch1
          echo "Batch 1 health check completed"

      - name: Create deployment summary
        run: |
          echo "# P1 Batch 1 Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Batch 1 deployed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: production" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed at: $(date -u)" >> $GITHUB_STEP_SUMMARY

  deploy-batch2:
    name: Deploy P1 Batch 2
    runs-on: ubuntu-latest
    needs: deploy-batch1

    environment:
      name: production-p1-batch2
      url: https://flow-nexus.ruv.io/p1/batch2

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: p1-build-output
          path: dist/

      - name: Install dependencies
        run: npm ci --production

      - name: Deploy Batch 2
        run: bash ./scripts/deploy-p1.sh --batch=2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_ENV: production
          P1_BATCH: 2

      - name: Health check Batch 2
        run: |
          echo "Running post-deployment health checks for Batch 2..."
          sleep 5
          npm run health-check:p1:batch2
          echo "Batch 2 health check completed"

  deploy-batch3:
    name: Deploy P1 Batch 3
    runs-on: ubuntu-latest
    needs: deploy-batch2

    environment:
      name: production-p1-batch3
      url: https://flow-nexus.ruv.io/p1/batch3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: p1-build-output
          path: dist/

      - name: Install dependencies
        run: npm ci --production

      - name: Deploy Batch 3
        run: bash ./scripts/deploy-p1.sh --batch=3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_ENV: production
          P1_BATCH: 3

      - name: Health check Batch 3
        run: |
          echo "Running post-deployment health checks for Batch 3..."
          sleep 5
          npm run health-check:p1:batch3
          echo "Batch 3 health check completed"

  deploy-batch4:
    name: Deploy P1 Batch 4
    runs-on: ubuntu-latest
    needs: deploy-batch3

    environment:
      name: production-p1-batch4
      url: https://flow-nexus.ruv.io/p1/batch4

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: p1-build-output
          path: dist/

      - name: Install dependencies
        run: npm ci --production

      - name: Deploy Batch 4
        run: bash ./scripts/deploy-p1.sh --batch=4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_ENV: production
          P1_BATCH: 4

      - name: Health check Batch 4
        run: |
          echo "Running post-deployment health checks for Batch 4..."
          sleep 5
          npm run health-check:p1:batch4
          echo "Batch 4 health check completed"

  deploy-batch5:
    name: Deploy P1 Batch 5
    runs-on: ubuntu-latest
    needs: deploy-batch4

    environment:
      name: production-p1-batch5
      url: https://flow-nexus.ruv.io/p1/batch5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: p1-build-output
          path: dist/

      - name: Install dependencies
        run: npm ci --production

      - name: Deploy Batch 5
        run: bash ./scripts/deploy-p1.sh --batch=5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEPLOY_ENV: production
          P1_BATCH: 5

      - name: Health check Batch 5
        run: |
          echo "Running post-deployment health checks for Batch 5..."
          sleep 5
          npm run health-check:p1:batch5
          echo "Batch 5 health check completed"

      - name: Final deployment summary
        run: |
          echo "# P1 Complete Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All P1 batches deployed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "- Batch 1: ✓ Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Batch 2: ✓ Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Batch 3: ✓ Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Batch 4: ✓ Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Batch 5: ✓ Deployed" >> $GITHUB_STEP_SUMMARY

  rollback-on-failure:
    name: Rollback on Deployment Failure
    runs-on: ubuntu-latest
    needs: [deploy-batch1, deploy-batch2, deploy-batch3, deploy-batch4, deploy-batch5]
    if: failure()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine failed batch
        id: failed-batch
        run: |
          if [ "${{ needs.deploy-batch5.result }}" == "failure" ]; then
            echo "batch=5" >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy-batch4.result }}" == "failure" ]; then
            echo "batch=4" >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy-batch3.result }}" == "failure" ]; then
            echo "batch=3" >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy-batch2.result }}" == "failure" ]; then
            echo "batch=2" >> $GITHUB_OUTPUT
          elif [ "${{ needs.deploy-batch1.result }}" == "failure" ]; then
            echo "batch=1" >> $GITHUB_OUTPUT
          else
            echo "batch=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Rollback deployment
        run: |
          echo "Deployment failed at batch ${{ steps.failed-batch.outputs.batch }}. Initiating rollback..."
          bash ./scripts/deploy-p1.sh --rollback --batch=${{ steps.failed-batch.outputs.batch }}
          echo "Rollback completed"

      - name: Notify failure
        run: |
          echo "# P1 Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment failed at batch ${{ steps.failed-batch.outputs.batch }} and has been rolled back" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  status-check:
    name: P1 CI/CD Status Check
    runs-on: ubuntu-latest
    needs:
      - typecheck
      - lint
      - p1-unit-tests
      - p0-p1-integration-tests
      - feature-flag-tests
      - batch-compatibility-tests
      - build
      - regression-tests
      - security-audit
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          echo "# P1 CI/CD Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All required checks completed" >> $GITHUB_STEP_SUMMARY
          echo "- TypeCheck: ${{ needs.typecheck.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- P1 Unit Tests: ${{ needs.p1-unit-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- P0+P1 Integration Tests: ${{ needs.p0-p1-integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Feature Flag Tests: ${{ needs.feature-flag-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Batch Compatibility: ${{ needs.batch-compatibility-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Regression Tests: ${{ needs.regression-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security Audit: ${{ needs.security-audit.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any required job failed
        if: |
          needs.typecheck.result == 'failure' ||
          needs.lint.result == 'failure' ||
          needs.p1-unit-tests.result == 'failure' ||
          needs.p0-p1-integration-tests.result == 'failure' ||
          needs.feature-flag-tests.result == 'failure' ||
          needs.batch-compatibility-tests.result == 'failure' ||
          needs.build.result == 'failure' ||
          needs.regression-tests.result == 'failure'
        run: |
          echo "One or more required jobs failed"
          exit 1
